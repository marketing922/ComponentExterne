<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ventes Flash Countdown</title>
    <style>
        html, body {
            margin: 0; padding: 0;
            font-family: Arial, sans-serif;
            background: #fff;
            display: flex;
            flex-direction: column; /* 垂直排列标题和倒计时 */
            align-items: center;
            justify-content: center;
            /* 移除固定高度，让内容自适应 */
            min-height: 150px; 
        }

        /* 标题样式 */
        .text-title {
            padding: 0.4em 1em;
            background-color: #f5f9f7;
            margin-bottom: 10px;
            text-align: center;
            border-radius: 4px;
            width: 90%;
            max-width: 600px;
        }
        .text-title > p {
            font-size: 1.2em;
            margin: 0;
            color: #33a853; /* 对应 text-green */
        }

        /* 倒计时容器样式 */
        .countdown-container {
            display: flex; justify-content: center; flex-wrap: nowrap;
            width: 100%; padding: 0 10px; text-align: center;
        }
        .countdown-box {
            margin: 5px; text-align: center; flex: 1;
            min-width: 60px; max-width: 100px; position: relative;
        }
        .countdown-box:not(:last-child):after {
            content: ":"; /* 用冒号比横线更节省空间，也可改回 "-" */
            position: absolute; right: -8px; top: 45%;
            transform: translateY(-50%); color: #DDD;
            font-size: 24px; font-weight: bold;
        }
        .countdown-value {
            font-size: 28px; font-weight: bold;
            color: #33a853; background-color: white;
            display: block;
        }
        .countdown-label {
            margin-top: 5px; color: #33a853;
            font-size: 12px; text-transform: uppercase;
        }
        .countdown-hidden { visibility: hidden; }
    </style>
</head>

<body>

    <div id="dynamic-title" class="text-title" style="display:none;">
        <p><strong id="title-text">...</strong></p>
    </div>

    <div id="countdown-wrapper" class="countdown-hidden">
        <div class="countdown-container">
            <div class="countdown-box">
                <div id="days" class="countdown-value">00</div>
                <div id="label-days" class="countdown-label">Jours</div>
            </div>
            <div class="countdown-box">
                <div id="hours" class="countdown-value">00</div>
                <div id="label-hours" class="countdown-label">Heures</div>
            </div>
            <div class="countdown-box">
                <div id="minutes" class="countdown-value">00</div>
                <div id="label-minutes" class="countdown-label">Minutes</div>
            </div>
            <div class="countdown-box">
                <div id="seconds" class="countdown-value">00</div>
                <div id="label-seconds" class="countdown-label">Secondes</div>
            </div>
        </div>
    </div>

    <script>
    (function () {
        // ================= 配置区域 =================
        // 定义多语言文案
        const i18n = {
            "fr": {
                activeTitle: "Fin des ventes flash",    // 活动进行中显示的标题
                upcomingTitle: "Prochaines ventes flash", // 下次活动显示的标题
                labels: ["Jours", "Heures", "Minutes", "Secondes"]
            },
            "en": {
                activeTitle: "Flash sales end in",
                upcomingTitle: "Next flash sales in",
                labels: ["Days", "Hours", "Minutes", "Seconds"]
            },
            "zh-CN": {
                activeTitle: "限时特卖结束倒计时",
                upcomingTitle: "距离下次特卖还有",
                labels: ["天", "时", "分", "秒"]
            }
        };

        // 获取 URL 参数中的语言，默认 fr
        const params = new URLSearchParams(window.location.search);
        const langParam = params.get("language");
        const debugDateParam = params.get("debug-date");
        // 如果传参是 zh-CN, en, fr 则使用，否则默认 fr
        const currentLang = (langParam && i18n[langParam]) ? langParam : "fr";
        const textData = i18n[currentLang];

        // ================= 核心逻辑：计算巴黎时间与目标 =================
        function calculateTarget() {
            // 1. 获取当前时间
            //const now = new Date();
            const now = debugDateParam ? new Date(debugDateParam) : new Date();
            
            // 2. 将当前时间转为巴黎时间对象，以便获取星期几和小时
            // 使用 Intl API 处理夏令时/冬令时
            const parisTimeStr = now.toLocaleString("en-US", {timeZone: "Europe/Paris"});
            const parisDate = new Date(parisTimeStr);

            const day = parisDate.getDay();   // 0=Sun, 1=Mon, 2=Tue, 3=Wed ...
            const hour = parisDate.getHours();
            
            // 逻辑判断：
            // 窗口期：周二 10:00 (含) ~ 周三 10:00 (不含)
            let isFlashSaleActive = false;

            if (day === 2 && hour >= 10) {
                // 周二 10点以后
                isFlashSaleActive = true;
            } else if (day === 3 && hour < 10) {
                // 周三 10点以前
                isFlashSaleActive = true;
            }

            // 3. 确定目标时间字符串 (ISO格式: YYYY-MM-DDTHH:mm:ss)
            let targetDateObj = new Date(parisDate); // 克隆一份巴黎时间
            targetDateObj.setMinutes(0);
            targetDateObj.setSeconds(0);
            targetDateObj.setMilliseconds(0);

            if (isFlashSaleActive) {
                // 如果正在活动中，目标是 "本周三 10:00"
                // 此时 parisDate 可能是周二(day2)或周三(day3)
                // 如果是周二，加1天；如果是周三，加0天（但在前面逻辑里周三必然<10点，所以目标是今天10点）
                const daysToAdd = (3 - day + 7) % 7; 
                targetDateObj.setDate(parisDate.getDate() + daysToAdd);
                targetDateObj.setHours(10);
            } else {
                // 如果是等待期，目标是 "下个周二 10:00"
                // 计算距离下个周二还有几天
                // 目标 day = 2
                let daysUntilNextTue = (2 - day + 7) % 7;
                if (daysUntilNextTue === 0 && hour >= 10) {
                    // 如果今天是周二且过了10点（实际上这种情况上面 isFlashSaleActive 会捕获，
                    // 但为了逻辑严谨：如果今天是周三10点后，daysUntilNextTue是6）
                    // 修正逻辑：
                    // 如果今天是周二且<10点 -> 目标是今天 (days=0)
                    // 如果是周三10点后 -> 目标是下周二 (days=6)
                }
                
                // 简单算法：让日期不断+1直到是周二，且如果就是当天必须是未来
                // 更好的算法：
                // 目前是非活动期。
                // 如果是周二 <10点 -> 目标今天10点
                // 如果是周三 >=10点, 周四, 周五... -> 目标下周二
                
                if (day === 2 && hour < 10) {
                     daysUntilNextTue = 0;
                } else {
                     // 否则找下一个周二
                     if (daysUntilNextTue === 0) daysUntilNextTue = 7; 
                }
                
                targetDateObj.setDate(parisDate.getDate() + daysUntilNextTue);
                targetDateObj.setHours(10);
            }

            // 构造 ISO 字符串用于传递给原来的逻辑，或者直接计算 diff
            // 这里我们需要算出 UTC 时间戳。
            // 因为 targetDateObj 是我们在 "巴黎时间思维" 下构建的 Date 对象
            // 我们需要反向把它当做巴黎时间解析出绝对时间戳。
            
            const year = targetDateObj.getFullYear();
            const month = targetDateObj.getMonth() + 1;
            const d = targetDateObj.getDate();
            const h = targetDateObj.getHours();
            
            // 使用你提供的辅助函数逻辑计算 UTC 时间戳
            const targetTimestamp = zonedDateTimeToUTCTimestamp(year, month - 1, d, h, 0, 0, "Europe/Paris");

            return {
                isFlashSaleActive,
                targetTimestamp
            };
        }

        // ================= 工具函数 (来自你的源代码) =================
        function zonedDateTimeToUTCTimestamp(year, month, day, hour, minute, second, timeZone) {
            const isoLocal = `${year.toString().padStart(4, "0")}-${(month + 1).toString().padStart(2, "0")}-${day.toString().padStart(2, "0")}T${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}:${second.toString().padStart(2, "0")}`;
            const localStr = new Date(isoLocal).toLocaleString("en-US", { timeZone });
            return new Date(localStr).getTime();
        }

        // ================= 界面更新 =================
        function updateUI() {
            const state = calculateTarget();
            
            // 1. 设置标题
            const titleEl = document.getElementById("title-text");
            const titleWrapper = document.getElementById("dynamic-title");
            
            if (state.isFlashSaleActive) {
                titleEl.textContent = textData.activeTitle;
            } else {
                titleEl.textContent = textData.upcomingTitle;
            }
            titleWrapper.style.display = "block"; // 准备好后显示

            // 2. 设置倒计时标签语言
            document.getElementById("label-days").textContent = textData.labels[0];
            document.getElementById("label-hours").textContent = textData.labels[1];
            document.getElementById("label-minutes").textContent = textData.labels[2];
            document.getElementById("label-seconds").textContent = textData.labels[3];

            // 3. 执行倒计时计算
            const now = Date.now();
            const distance = state.targetTimestamp - now;

            if (distance < 0) {
                // 稍微过了一点点时间（比如刷新瞬间），显示00并等待下一秒自动修正逻辑
                document.getElementById("days").textContent = "00";
                document.getElementById("hours").textContent = "00";
                document.getElementById("minutes").textContent = "00";
                document.getElementById("seconds").textContent = "00";
            } else {
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById("days").textContent = String(days).padStart(2, "0");
                document.getElementById("hours").textContent = String(hours).padStart(2, "0");
                document.getElementById("minutes").textContent = String(minutes).padStart(2, "0");
                document.getElementById("seconds").textContent = String(seconds).padStart(2, "0");
                
                document.getElementById("countdown-wrapper").classList.remove("countdown-hidden");
            }
        }

        // 启动
        updateUI();
        setInterval(updateUI, 1000);

    })();
    </script>
</body>
</html>

